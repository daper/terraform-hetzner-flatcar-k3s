---
passwd:
  users:
    - name: core
      ssh_authorized_keys: [${ssh_key}]
storage:
  files:
    - path: /var/lib/iptables/rules-save
      filesystem: root
      mode: 0644
      contents:
        inline: |
          # Generated by iptables-save v1.6.2 on Wed Feb 17 18:21:09 2021
          *filter
          :INPUT DROP [49:2092]
          :FORWARD DROP [0:0]
          :OUTPUT ACCEPT [592:105319]
          -A INPUT -i lo -j ACCEPT
          -A INPUT -m state --state ESTABLISHED -j ACCEPT
          -A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
          -A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
          -A INPUT -p tcp -m tcp --dport 443 -j ACCEPT
          -A INPUT -p tcp -m tcp --dport 6443 -j ACCEPT
          -A INPUT -s 127.0.0.1/32 -d 127.0.0.1/32 -j ACCEPT
          -A INPUT -j DROP
          COMMIT
          # Completed on Wed Feb 17 18:21:09 2021
          # Generated by iptables-save v1.6.2 on Wed Feb 17 18:21:09 2021
          *nat
          :PREROUTING ACCEPT [92:4342]
          :INPUT ACCEPT [52:2730]
          :OUTPUT ACCEPT [7:621]
          :POSTROUTING ACCEPT [7:621]
          :DOCKER - [0:0]
          COMMIT
          # Completed on Wed Feb 17 18:21:09 2021
    - path: /etc/hostname
      filesystem: root
      mode: 0644
      contents:
        inline: ${name}

  links:
    - path: /etc/systemd/system/basic.target.wants/iptables-restore.service
      target: /usr/lib/systemd/system/iptables-restore.service
      overwrite: false
      hard: false
    - path: /etc/systemd/system/multi-user.target.wants/docker.service
      target: /run/systemd/system/docker.service
      overwrite: false
      hard: false